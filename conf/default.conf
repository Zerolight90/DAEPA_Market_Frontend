server {
  listen 80;
  server_name _;

  # 헬스체크
  location /nginx-health {
    return 200 "ok";
    add_header Content-Type text/plain;
  }

  # ─────────────────────────────────────────────
  # 1) 프론트: Next.js 컨테이너로 프록시
  #    ※ 컨테이너 이름과 정확히 일치해야 함
  # ─────────────────────────────────────────────
  location / {
    proxy_pass http://daepa-frontend:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # ─────────────────────────────────────────────
  # 2) API: 백엔드 EC2로 프록시
  # ─────────────────────────────────────────────
  location /api/ {
    proxy_pass http://52.79.241.142:8080;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # ─────────────────────────────────────────────
  # 3) WebSocket(STOMP): 반드시 업그레이드 헤더 포함
  #    ※ proxy_pass 에 경로(/ws-stomp)를 다시 붙이지 말기!
  #       location 이 /ws-stomp 이면 원 요청 경로가 그대로 전달됨
  # ─────────────────────────────────────────────
  location /ws-stomp {
    proxy_pass http://52.79.241.142:8080;
    proxy_http_version 1.1;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }

  # ─────────────────────────────────────────────
  # 4) S3 프록시 (/uploads/* → 버킷의 /* 매핑)
  #    - HTTPS 사용, Host 헤더를 S3 버킷 도메인으로 지정
  #    - 캐시 헤더(optional)
  # ─────────────────────────────────────────────
  location /uploads/ {
    proxy_pass https://daepa-s3.s3.ap-northeast-2.amazonaws.com/;  # 끝에 슬래시 중요
    proxy_http_version 1.1;

    # SNI/Host
    proxy_set_header Host daepa-s3.s3.ap-northeast-2.amazonaws.com;
    proxy_ssl_server_name on;

    # 원본 정보 전달(선택)
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # 큰 파일 대비(선택)
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
    proxy_force_ranges on;

    # 캐시(선택)
    expires 7d;
    add_header Cache-Control "public, max-age=604800, immutable";
  }

  # (선택) 업로드 용량 제한 완화 – 필요 시
  client_max_body_size 20m;
}