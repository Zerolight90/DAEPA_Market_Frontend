server {
  listen 80;
  server_name _;

  # Next.js ì»¨í…Œì´ë„ˆë¡œ í”„ë¡ì‹œ (compose ì„œë¹„ìŠ¤ëª… ì‚¬ìš© ê¶Œì¥)
  location / {
    proxy_pass http://frontend:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }

  # === API í”„ë¡ì‹œ ===
  # /api/actuator/health -> ë°±ì—”ë“œì˜ /actuator/health ë¡œ ì „ë‹¬ (ë’¤ ìŠ¬ë˜ì‹œ ì¤‘ìš”!)
  location /api/ {
    # ğŸ’¡ ì¤‘ë³µëœ /api/api/... â†’ /api/... ë¡œ êµì •
    rewrite ^/api/api/(.*)$ /api/$1 break;
    # (ì˜µì…˜) // ì—¬ëŸ¬ ê°œ â†’ / í•˜ë‚˜
    rewrite ^/api//+ /api/ last;

    add_header X-Api-Proxy "hit" always;  # í™•ì¸ìš© ì„ì‹œ í—¤ë”
    proxy_pass http://52.79.241.142:8080/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # === WebSocket í”„ë¡ì‹œ(ì“°ë©´ ìœ ì§€, ì•„ë‹ˆë©´ ì‚­ì œ ê°€ëŠ¥) ===
  location /ws {
    proxy_pass http://52.79.241.142:8080/ws;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }
}

