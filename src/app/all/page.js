// src/app/all/page.js (content 부분만 전체 교체해도 됨)"use client";import { useEffect, useState, Suspense } from "react";import { useSearchParams } from "next/navigation";import Link from "next/link";import api from "@/lib/api"; // axios 인스턴스 가져오기import { Endpoints } from "@/app/sell/api"; // Endpoints만 가져오기import FavoriteBorderIcon from "@mui/icons-material/FavoriteBorder";import FavoriteIcon from "@mui/icons-material/Favorite";import styles from "./all.module.css";import { CircularProgress, Box, Typography } from "@mui/material";function AllProductsContent() {    const searchParams = useSearchParams();    const sort = searchParams.get("sort") || "recent";    const keyword = (searchParams.get("keyword") || "").trim();    const [products, setProducts] = useState([]);    const [loading, setLoading] = useState(true);    const [page, setPage] = useState(0);    const [hasMore, setHasMore] = useState(true);    // accessToken은 더 이상 클라이언트에서 직접 관리하지 않습니다.    // 브라우저가 HttpOnly 쿠키를 자동으로 전송합니다.    const fillFavoriteStatus = async (list) => {        // 로그인 상태가 아니면 찜 상태를 확인할 필요가 없습니다.        // API 호출이 401을 반환하면 axios 인터셉터 또는 개별 catch 블록에서 처리됩니다.        const updated = await Promise.all(            list.map(async (item) => {                try {                    // axios 인스턴스를 사용하여 API 호출                    const res = await api.get(Endpoints.favoriteStatus(item.id));                    // axios는 응답 데이터를 .data 속성에 담습니다.                    return {                        ...item,                        favorited: !!res.data.favorited,                        favoriteCount: res.data.count ?? 0,                    };                } catch (e) {                    // 401 에러는 로그인되지 않은 상태를 의미합니다.                    // 이 경우 찜 상태를 업데이트하지 않고 원래 아이템을 반환합니다.                    if (e.response?.status === 401) {                        return item;                    }                    console.error(`찜 상태 조회 실패 (상품 ID: ${item.id}):`, e);                    return item;                }            })        );        return updated;    };    async function loadProducts(reset = false) {        try {            setLoading(true);            const targetPage = reset ? 0 : page;            const params = new URLSearchParams();            params.set("sort", sort);            params.set("page", String(targetPage));            params.set("size", "20");            if (keyword) {                params.set("keyword", keyword);            }            // axios 인스턴스를 사용하여 API 호출            const response = await api.get(`/products?${params.toString()}`);            const list = Array.isArray(response.data?.content) ? response.data.content : [];            let mapped = list.map((p) => ({                id: p.pdIdx,                title: p.pdTitle,                price: p.pdPrice,                thumb: p.pdThumb,                createdAt: p.pdCreate,                dsell: p.dsell ?? p.dSell ?? p.d_sell ?? null,                dstatus: p.dstatus ?? p.dStatus ?? p.d_status ?? null,                pdDel: p.pdDel ?? p.pd_del ?? 0,                favorited: false,                favoriteCount: 0,            }));            // ✨ 여기서 삭제된 상품은 바로 버려도 됨            mapped = mapped.filter((p) => Number(p.pdDel ?? 0) === 0);            mapped = await fillFavoriteStatus(mapped);            if (reset) {                setProducts(mapped);                setPage(1);            } else {                setProducts((prev) => [...prev, ...mapped]);                setPage((prev) => prev + 1);            }            setHasMore(list.length >= 20);        } catch (e) {            console.error("[/all] 상품 불러오기 실패:", e);        } finally {            setLoading(false);        }    }    useEffect(() => {        loadProducts(true);        // eslint-disable-next-line react-hooks/exhaustive-deps    }, [sort, keyword]);    const handleMore = () => {        if (!loading && hasMore) loadProducts(false);    };    const handleToggleFavorite = async (e, productId) => {        e.preventDefault();        e.stopPropagation();        try {            // axios 인스턴스를 사용하여 API 호출            const response = await api.post(Endpoints.favoriteToggle(productId));            const data = response.data;            setProducts((prev) =>                prev.map((p) =>                    p.id === productId                        ? {                            ...p,                            favorited: !!data.favorited,                            favoriteCount: data.count ?? 0,                        }                        : p                )            );        } catch (err) {            if (err.response?.status === 401) {                alert("로그인이 필요합니다.");                return;            }            alert(`찜 처리 중 오류가 발생했습니다.\n${err.response?.data?.message || err.message}`);        }    };    return (        <div className={styles.page}>            <div className={styles.bcWrap}>                <Link href="/" className={styles.bc}>                    홈                </Link>                <span className={styles.sep}>/</span>                <span className={styles.bc}>전체 상품</span>            </div>            <main className={styles.container}>                <div className={styles.leftCol}>                    <div className={styles.section}>                        <div className={styles.listHead}>                            <h1 className={styles.title}>                                {sort === "favorite" ? "찜이 많은 상품" : "전체 상품"}                            </h1>                            <div className={styles.sortTabs}>                                <Link                                    href="/all?sort=recent"                                    className={                                        sort === "recent" ? styles.activeSort : styles.sortTab                                    }                                >                                    최신순                                </Link>                                <Link                                    href="/all?sort=favorite"                                    className={                                        sort === "favorite" ? styles.activeSort : styles.sortTab                                    }                                >                                    찜 많은 순                                </Link>                            </div>                        </div>                        <div className={styles.grid}>                            {products.map((item) => {                                const rawSell =                                    item.dsell ??                                    item.dSell ??                                    item.dstatus ??                                    item.dStatus ??                                    0;                                const sellState = Number(rawSell) || 0;                                const isSold = sellState === 1;                                const isTrading = sellState === 2;                                return (                                    <Link                                        key={item.id}                                        href={`/store/${item.id}`}                                        className={styles.card}                                    >                                        <div className={styles.thumbWrap}>                                            <img                                                src={item.thumb || "/images/no-image.png"}                                                alt={item.title}                                                className={styles.thumb}                                                style={{                                                    filter: isSold || isTrading ? "brightness(0.35)" : "none",                                                }}                                            />                                            {(isSold || isTrading) && (                                                <div className={styles.soldOverlay}>                                                    <div className={styles.soldCircle}>✓</div>                                                    <div>{isSold ? "판매완료" : "판매 중"}</div>                                                </div>                                            )}                                            <button                                                className={styles.heartBtn}                                                onClick={(e) => handleToggleFavorite(e, item.id)}                                                aria-label="찜하기"                                                title="찜하기"                                            >                                                {item.favorited ? (                                                    <FavoriteIcon className={styles.heartOn} />                                                ) : (                                                    <FavoriteBorderIcon className={styles.heartOff} />                                                )}                                                <span className={styles.heartCnt}>                          {item.favoriteCount}                        </span>                                            </button>                                        </div>                                        <div className={styles.meta}>                                            <div className={styles.prodTitle}>{item.title}</div>                                            <div className={styles.price}>                                                {item.price?.toLocaleString?.() ?? item.price}원                                            </div>                                            <div className={styles.date}>                                                {item.createdAt ? item.createdAt.slice(0, 10) : ""}                                            </div>                                        </div>                                    </Link>                                );                            })}                            {loading &&                                Array.from({ length: 6 }).map((_, i) => (                                    <div key={i} className={styles.skeleton}></div>                                ))}                            {!loading && products.length === 0 && (                                <p className={styles.empty}>상품이 없습니다.</p>                            )}                        </div>                        {hasMore && !loading && (                            <button onClick={handleMore} className={styles.moreBtn}>                                더 보기                            </button>                        )}                    </div>                </div>                <div className={styles.rightCol}>                    <div className={styles.infoCard}>                        <h3>알림</h3>                        <p>최근 3일 이내 판매완료된 상품은 목록에서 숨겨집니다.</p>                    </div>                </div>            </main>        </div>    );}[object Object]export default function AllProductsPage() {    return (        <Suspense            fallback={                <Box                    sx={{                        display: "flex",                        justifyContent: "center",                        alignItems: "center",                        height: "100vh",                    }}                >                    <CircularProgress />                    <Typography sx={{ ml: 2 }}>페이지를 불러오는 중...</Typography>                </Box>            }        >            <AllProductsContent />        </Suspense>    );}
