name: Deploy Frontend to EC2

on:
  push:
    branches:
      - zerolight   # í‘¸ì‹œ ì‹œ ìë™ë°°í¬ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 300s
          command_timeout: 120m
          script_stop: false
          script: |
            set -e
            cd ~/apps/frontend

            echo "[1/6] Git ì—…ë°ì´íŠ¸"
            cp -f .env /tmp/.env.backup 2>/dev/null || true
            git fetch --all
            git checkout zerolight
            git reset --hard origin/zerolight
            [ -f /tmp/.env.backup ] && mv /tmp/.env.backup .env

            echo "[2/6] ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ë° ìºì‹œ ì •ë¦¬"
            docker compose down || true
            docker system prune -af || true
            docker builder prune -af || true
            rm -rf .next || true

            echo "[3/6] ë¹Œë“œ ë° ë°°í¬ ì‹œì‘ (ê°•ì œ ìƒˆ ë¹Œë“œ)"
            docker compose build --no-cache --progress=plain
            docker compose up -d

            echo "[4/6] ìƒíƒœ í™•ì¸"
            docker compose ps

            echo "[5/6] ìµœê·¼ ë¡œê·¸ í™•ì¸"
            docker logs --tail=50 daepa-frontend || true

            echo "[6/6] ë°°í¬ ì™„ë£Œ ğŸ‰"
