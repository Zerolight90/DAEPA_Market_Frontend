name: Deploy Frontend

on:
  push:
    branches:
      - main            # main 브랜치에 push될 때만 실행
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy.yml'
      - 'docker/**'
      - 'Dockerfile'
      - 'compose.yaml'
      - 'docker-compose.yml'
  workflow_dispatch:     # Actions 탭에서 수동 실행 허용

concurrency:
  group: deploy-frontend
  cancel-in-progress: true

jobs:
  deploy:
    # 추가 가드: 소유 레포의 main일 때만 배포 실행
    if: |
      github.repository_owner == 'Zerolight90' &&
      github.ref == 'refs/heads/main'

    timeout-minutes: 120
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 캐시 노드 모듈
      - name: Cache Node modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 선택: 빌드 검증 (Next 빌드 실패 시 여기서 차단)
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build (validation only)
        run: npx next build --no-lint

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script_stop: true
          debug: false
          script: |
            set -euo pipefail
            cd ~/apps/frontend

            echo "[1/6] Git update"
            cp -f .env /tmp/.env.backup 2>/dev/null || true
            git fetch --all
            git checkout main
            git reset --hard origin/main
            [ -f /tmp/.env.backup ] && mv /tmp/.env.backup .env

            echo "[2/6] Cleanup containers and caches"
            docker compose down || true
            docker system prune -af || true
            docker builder prune -af || true

            if [ -d .next ]; then
              sudo -n chown -R $USER:$USER .next || true
              sudo -n chmod -R u+w .next || true
              sudo -n rm -rf .next || true
            fi

            echo "[3/6] Build and run"
            docker compose --progress=plain build --no-cache
            docker compose up -d

            echo "[4/6] Status"
            docker compose ps

            echo "[5/6] Recent logs"
            docker logs --tail=80 daepa-frontend || true

            echo "[6/6] Done"
