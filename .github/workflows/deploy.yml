name: Deploy Frontend to EC2

on:
  push:
    branches: ["zerolight"]

concurrency:
  group: frontend-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH into EC2 and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}

          # ğŸ”¥ í•µì‹¬ 3ì¤„
          timeout: 300s                # SSH ì„¸ì…˜ ìœ íš¨ì‹œê°„ (5ë¶„)
          command_timeout: 120m        # ëª…ë ¹ ì‹¤í–‰ íƒ€ì„ì•„ì›ƒ (2ì‹œê°„)
          script_stop: false           # ì‹¤íŒ¨í•´ë„ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ (ë””ë²„ê·¸ìš©)

          script: |
            set -e
            cd ~/apps/frontend

            echo "[1/5] Git ì—…ë°ì´íŠ¸"
            cp -f .env /tmp/.env.backup 2>/dev/null || true
            git fetch --all
            git checkout zerolight
            git reset --hard origin/zerolight
            [ -f /tmp/.env.backup ] && mv /tmp/.env.backup .env

            echo "[2/5] ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬"
            docker compose down

            echo "[3/5] ë¹Œë“œ ë° ë°°í¬ ì‹œì‘"
            # --no-cache ì œê±° (ìºì‹œ ì‚¬ìš©ìœ¼ë¡œ ì†ë„ â†‘)
            docker compose build --progress=plain
            docker compose up -d

            echo "[4/5] ìƒíƒœ í™•ì¸"
            docker compose ps

            echo "[5/5] ìµœê·¼ ë¡œê·¸ í™•ì¸"
            docker logs --tail=100 daepa-frontend || true
