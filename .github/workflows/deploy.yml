name: Deploy Frontend

on:
  push:
    branches:
      - main            # main ë¸Œëžœì¹˜ì— pushë  ë•Œë§Œ ì‹¤í–‰
    paths:
      - 'frontend/**'
      - 'conf/**'             # â† ì¶”ê°€
      - 'src/**'              # â† ì†ŒìŠ¤ ë³€ê²½ë„ íƒœìš°ë ¤ë©´
      - 'app/**'
      - 'public/**'
      - 'next.config.mjs'     # â† ì¶”ê°€
      - 'Dockerfile'
      - 'docker/**'
      - 'compose.yaml'
      - 'docker-compose.yml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:     # Actions íƒ­ì—ì„œ ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

concurrency:
  group: deploy-frontend
  cancel-in-progress: true

jobs:
  deploy:
    # ì¶”ê°€ ê°€ë“œ: main ë¸Œëžœì¹˜ + ë ˆí¬ì§€í† ë¦¬ ì†Œìœ ìžë§Œ ì‹¤í–‰
    if: |
      github.repository_owner == 'Zerolight90' &&
      github.ref == 'refs/heads/main'

    timeout-minutes: 240     # ðŸ”¸ ì „ì²´ Job ìµœëŒ€ 4ì‹œê°„
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Node ëª¨ë“ˆ ìºì‹œ
      - name: Cache Node modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # Next.js ë¹Œë“œ ìºì‹œ
      - name: Cache Next.js build
        uses: actions/cache@v3
        with:
          path: ~/.next
          key: ${{ runner.os }}-next-build-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-next-build-

      # Node í™˜ê²½ ì„¸íŒ…
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: npm ci

      # Next.js ë¹Œë“œ ê²€ì¦ (ì—ëŸ¬ë‚˜ë©´ ì—¬ê¸°ì„œ ì¤‘ë‹¨)!
      - name: Build (validation only)
        run: npx next build --no-lint

      # SSHë¡œ ì‹¤ì œ ì„œë²„ì— ë°°í¬
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script_stop: true
          debug: false
          timeout: 60m           # ðŸ”¸ SSH ì„¸ì…˜ ìµœëŒ€ ì‹œê°„
          command_timeout: 60m   # ðŸ”¸ ëª…ë ¹ ì‹¤í–‰ ì‹œê°„(ê¸°ë³¸ 10ë¶„ â†’ 60ë¶„ìœ¼ë¡œ í™•ìž¥)
          script: |
            set -euo pipefail
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1
            
            cd ~/apps/frontend
            
            echo "[1/6] Git update"
            git fetch --all
            git checkout main
            git reset --hard origin/main
            
            echo "[2/6] Create .env file"
            echo "${{ secrets.DAEPA_FRONTEND_ENV }}" > .env
            echo ".env file created."
            
            echo "[3/6] Stop and prepare"
            docker compose down || true
            
            echo "Pruning old images and builder cache..."
            docker image prune -f
            docker builder prune -f --filter 'until=168h'
            
            echo "[4/6] Build with cache"
            docker compose build --progress=plain
            
            echo "[5/6] Start containers"
            docker compose up -d
            
            echo "[6/6] Status & logs"
            docker compose ps
            docker logs --tail=80 daepa-frontend || true
            
            echo "âœ… Deploy complete!"
