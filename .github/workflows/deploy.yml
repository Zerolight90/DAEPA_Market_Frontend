name: Deploy Frontend to GHCR

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'public/**'
      - 'conf/**'
      - 'next.config.mjs'
      - 'package*.json'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  # ghcr.io/소유자명/이미지명 - 소문자로 작성
  IMAGE_NAME: ghcr.io/${{ toLower(github.repository_owner) }}/daepa-market-frontend

jobs:
  # =================================================================
  #  1. Docker 이미지를 빌드하고 GHCR(GitHub Container Registry)에 Push
  # =================================================================
  build-and-push:
    name: Build and Push to GHCR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # GHCR에 쓰기 권한

    outputs:
      image_tag: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          # Git의 Short SHA를 이미지 태그로 사용 (예: ghcr.io/owner/image:a1b2c3d)
          tags: type=sha,prefix=,format=short

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # 빌드 시 사용할 ARG 변수들 (Secrets에서 주입)
          build-args: |
            NEXT_PUBLIC_API_BASE=${{ secrets.NEXT_PUBLIC_API_BASE }}
            NEXT_PUBLIC_API_ORIGIN=${{ secrets.NEXT_PUBLIC_API_ORIGIN }}
            NEXT_PUBLIC_WS_BASE=${{ secrets.NEXT_PUBLIC_WS_BASE }}
            NEXT_PUBLIC_SITE_URL=${{ secrets.NEXT_PUBLIC_SITE_URL }}
          # 빌드 캐시 설정
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # =================================================================
  #  2. 배포 서버에 접속하여 새 이미지를 Pull 받고 컨테이너 재시작
  # =================================================================
  deploy:
    name: Deploy to Server
    needs: build-and-push # build-and-push Job이 성공해야 실행
    runs-on: ubuntu-latest
    if: |
      github.repository_owner == 'Zerolight90' &&
      github.ref == 'refs/heads/main'

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script_stop: true
          debug: false
          timeout: 15m
          command_timeout: 15m
          script: |
            set -euo pipefail
            cd ~/apps/frontend

            echo "[1/6] Git update (for docker-compose.yml)"
            git fetch --all
            git checkout main
            git reset --hard origin/main

            echo "[2/6] Create .env file with new image tag"
            # build-and-push Job에서 전달받은 이미지 태그를 .env 파일에 쓰기
            echo "IMAGE_TAG=${{ needs.build-and-push.outputs.image_tag }}" > .env
            # 나머지 환경변수 추가
            echo "${{ secrets.DAEPA_FRONTEND_ENV }}" >> .env
            echo ".env file created."

            echo "[3/6] Log in to GHCR"
            # GHCR_TOKEN을 사용하여 서버에서 GHCR에 로그인
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin

            echo "[4/6] Pull new image and start containers"
            docker compose pull
            docker compose up -d --remove-orphans

            echo "[5/6] Prune old images"
            docker image prune -f

            echo "[6/6] Status & logs"
            docker compose ps
            docker logs --tail=80 daepa-frontend || true

            echo "✅ Deploy complete!"
