name: Deploy Frontend to EC2

on:
  push:
    branches: ["zerolight"]

concurrency:
  group: frontend-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH into EC2 and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 60s
          command_timeout: 60m
          script: |
            set -e
            mkdir -p ~/.ssh
            ssh-keyscan -t ed25519 github.com >> ~/.ssh/known_hosts || true
            chmod 644 ~/.ssh/known_hosts

            cd ~/apps/frontend

            echo "[1/5] Git 업데이트"
            cp -f .env /tmp/.env.backup 2>/dev/null || true
            git fetch --all
            git checkout zerolight
            git reset --hard origin/zerolight
            [ -f /tmp/.env.backup ] && mv /tmp/.env.backup .env

            echo "[2/5] 기존 컨테이너 정리"
            docker compose down

            echo "[3/5] 빌드 및 배포 시작"
            docker compose build --progress=plain
            docker compose up -d

            echo "[4/5] 상태 확인"
            docker compose ps

            echo "[5/5] 최근 로그 확인"
            docker logs --tail=100 daepa-frontend || true
